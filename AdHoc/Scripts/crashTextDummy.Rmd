---
title: "Crash Text Dummy Analysis"
output: html_notebook
---

###Summary
#####Key Takeaways:
1. There is clear evidence of the effectiveness of the campaign in reducing the frequency of texting and driving
2. The effectiveness dampens over time, but does persist even on a 4-8 week horizon
3. Effectiveness is most prominent amongst licensed drivers, and may actually be detrimental in non-licensed drivers
4. Effectiveness varies based on several identified factors, elaborated upon below
5. Ability to tie this data to our broader information base is critical to deriving additional insights
6. Future experiments should maintain a control population throughout the life of the experiment, rather than just at its bookends

###Initialize Environment
```{r}
#Load required packages and custom functions
library(rpart)
library(rpart.plot)
library(caret)
library(ROCR)
library(knitr)
source('~/Documents/AdHoc/Scripts/init.R')
source('~/Documents/AdHoc/Scripts/DSUtils.R')
```

###Prep Data
- After pulling the data into the environment, some fields were manipulated based on their distributions
- For instance, people who said they did not drive were flagged and removed from subsequent analysis
- If a field had values concentrated in one or two buckets, or many buckets with few values, the many buckets were reclassified into a more generic umbrella category
- The outcome I focused on was whether or not someone texted and drove since other levels were either very rare or irrelevant
```{r, message=FALSE, warning=FALSE}
#Write and execute functions to prepare individual files
prepControl <- function(path) {
  ctdControl <- 
    read_csv(path) %>%
    tbl_dt() %>%
    setNames(
      c('timestamp','gender','geography','licenseType','driveFrequency','intervenedFriend',
        'intervenedFamily','textDriveFreq','textDriveDanger','email')
    ) %>%
    mutate(
      group = 'Control'
    )
  return(ctdControl)
}

prep4_8 <- function(path) {
  ctd4_8 <- 
    read_csv(path) %>%
    tbl_dt() %>%
    setNames(
      c('timestamp','gender','geography','licenseType','driveFrequency','intervenedFriend',
        'intervenedFamily','textDriveFreq','textDriveDanger','takeAction')
    ) %>%
    mutate(
      group = '4-8 Weeks'
    )
  return(ctd4_8)
}

prep72 <- function(path) {
  
  ctd72 <- 
    read_csv(path) %>%
    tbl_dt() %>% 
    setNames(
      c('timestamp','gender','geography','licenseType','driveFrequency','intervenedFriend',
        'intervenedFamily','textDriveFreq','textDriveDanger','ctdStrategies','ctd.willInterveneFriend',
        'ctd.willInterveneFamily','takeAction')
    ) %>%
    mutate(
      group = '72 Hours'
    )
  
  return(ctd72)
}

#Combine Files into one file with flags
prepData <- function(pathControl, pathExp1, pathExp2) {
  control <- prepControl(pathControl)
  ctd4_8 <- prep4_8(pathExp1)
  ctd72 <- prep72(pathExp2)
  
  ctd <- 
    rbind(control, ctd4_8, ctd72, fill=T) %>%
    mutate(
      date = as.Date(substr(timestamp, 1,10), format='%Y/%m/%d')
    ) %>%
    tbl_dt()
  
  return(ctd)
  
}

ctd <- 
  prepData(
    '~/Documents/AdHoc/Data/Crash Text Dummy - Control.csv', 
    '~/Documents/AdHoc/Data/Crash Text Dummy - 4-8 Weeks.csv', 
    '~/Documents/AdHoc/Data/Crash Text Dummy - 72 Hours.csv'
    )

ages <- read_csv('~/Documents/AdHoc/Data/email_age_ctd.csv')

#Re-label variables for ease of use and removing rare levels
#Create Additional useful fields
textDriveTable<- ctd[,.N,by=textDriveFreq]
genderTable <- ctd[,.N,by=gender]

ctd %<>%
  mutate(
    textDrive.yn = ifelse(textDriveFreq=="I don't drive", NA, 
                                  ifelse(textDriveFreq=='Never', 0, 1)),
    textDrive = factor(ifelse(grepl('Only', textDriveFreq), 'Sometimes', textDriveFreq), levels=c('Often','Sometimes','Never')),
    licenseType = ifelse(licenseType=="Driver's license", 'License', 
                         ifelse(licenseType=="Driver's permit", 'Permit', 'Neither')),
    gender = ifelse(gender=='Man', 'Male', 
                    ifelse(gender=='Woman', 'Female', 'Other/DNR')),
    intervenedFriend = ifelse(!(intervenedFriend %in% c('No','Yes')), 'NotApplicable', intervenedFriend),
    intervenedFamily = ifelse(!(intervenedFriend %in% c('No','Yes')), 'NotApplicable', intervenedFamily),
    #Factors in R are numbers with labels. We can use this to display characters variables in the order we want. 
    #Below, I turn "group" into a factor so it always displays in the order specified
    group = factor(group, levels=c('Control','72 Hours','4-8 Weeks')),
    timePeriod = ifelse(date < '2017-03-21', 'Before', 'After')
  ) %>%
  left_join(ages, copy=T)
kable(textDriveTable)
kable(genderTable)
```

###Distribution of Surveys by Date
- Curiously, surveys taken 72 hours post campaign began and were distributed more flatly throughout
- 4-8 Week surveys were frontloaded with a long tail
- Control group surveys were largely taken near the beginning and end of the survey cycle
```{r, message=FALSE, warning=FALSE}
ggplot(ctd, aes(x=group,y=date)) + 
  geom_violin(position='dodge',aes(fill=group)) + 
  coord_flip() + theme(legend.position="none") + 
  ggtitle('Survey Date by Group') + 
  theme(plot.title = element_text(hjust = 0.5))
```

###Difference in Difference
- The fact that control group surveys were taken before and after the time period of interest allows us to construct a difference in difference analysis. 
- This techniques lets us take the changes in the control group as an estimate of all effects outside of the experiment
- By substracting away this "noise" from the changes observed in the experiment group, we arrive at an estimate of the impact of the campaign itself
- We see that the effect of the campaign in the first 72 hours is an 11.5% reduction in texting and driving
- We also see that the effect of the campaign in the 4-8 week period after falls to a reduction of about 1.6%
```{r, message=FALSE, warning=FALSE}
DnD <- function(data, pivot) {
  
  DnD <-
    data %>%
    filter(!is.na(get(pivot))) %>%
    group_by(group, timePeriod) %>%
    summarise(
      Frequency = mean(get(pivot))
    ) %>%
    spread(timePeriod, Frequency, fill=ctd[group=='Control' & timePeriod=='Before',mean(get(pivot), na.rm=T)]) %>%
    select(group, Before, After) %>%
    mutate(
      Diff = After - Before
    ) 
  DnD <-
    rbind(
      DnD,
      data.frame(group='Effect - 72 Hours',Before=NA,After=NA,Diff=DnD[group=='72 Hours',Diff]-DnD[group=='Control',Diff]),
      data.frame(group='Effect - 4-8 Weeks',Before=NA,After=NA,Diff=DnD[group=='4-8 Weeks',Diff]-DnD[group=='Control',Diff])
    )
  
}

textDrive.DnD <- DnD(ctd, 'textDrive.yn') %>% kable(digits = 4, align = 'l') %>% print()
```

###Slice and Dice
- Now that we have some sense of the overall effect, we can start digging into how the effects differ by available pivotable characteristics
```{r, message=FALSE, warning=FALSE}
proportionPivot <- function(data, pivot=NULL) {
  if(is.null(pivot)) { 
    outcomeFreq <-
      ctd %>%
      as_tibble() %>%
      filter(textDrive != "I don't drive") %>%
      group_by_('textDrive', 'group') %>%
      summarise(
        count = n()
      ) %>%
      left_join(
        ctd %>% as_tibble %>% filter(textDrive != "I don't drive") %>% group_by_('group') %>% summarise(countGroup = n())
      ) %>%
      mutate(
        proportion = count / countGroup
      ) %>%
      tbl_dt()
  } else {
    outcomeFreq <-
      ctd %>%
      as_tibble() %>%
      filter(textDrive != "I don't drive") %>%
      group_by_('textDrive', 'group', pivot) %>%
      summarise(
        count = n()
      ) %>%
      left_join(
        ctd %>% as_tibble %>% filter(textDrive != "I don't drive") %>% group_by_('group', pivot) %>% summarise(countGroup = n())
      ) %>%
      mutate(
        proportion = count / countGroup
      ) %>%
      tbl_dt()
  }
  
  return(outcomeFreq)
  
}

proportionPlot <- function(data, wrap, title) {
  plot <- ggplot(data, aes(x=group, y=proportion, group=textDrive)) +
    geom_bar(stat='identity',position='stack',aes(fill=textDrive)) + facet_wrap(~get(wrap)) +
    scale_y_continuous(breaks = pretty_breaks(n=10)) +
    theme(plot.title = element_text(hjust = 0.5)) + ggtitle(paste(title))
  return(plot)
}

ggplot(proportionPivot(ctd), aes(x=group,y=proportion,group=textDrive)) +
  geom_bar(stat='identity',position='stack',aes(fill=textDrive)) +
  scale_y_continuous(breaks = pretty_breaks(n=10)) +
  theme(plot.title = element_text(hjust = 0.5)) + ggtitle('Overall')
```
#####License Type
- We see that the campaign is most effective for licensed drivers and doesn't seem effective for drivers with permits or who have neither
- The caveat is obviously that non-licensed drivers have peciliarly low rates of texting and driving
```{r, message=FALSE, warning=FALSE}
proportionsLicenseType <- 
  proportionPivot(ctd, 'licenseType') %>%
  proportionPlot('licenseType', 'License Type') %>%
  print()
```
#####Gender
- Men and women show similar behavior patterns
```{r, message=FALSE, warning=FALSE}
proportionsGender <- 
  proportionPivot(ctd, 'gender') %>%
  proportionPlot('gender', 'Gender') %>%
  print()
```
#####Driving Frequency
- Daily drivers appear to be the most responsive
- Weekly and monthly drivers seem less responsive, but their response is more consistent over time
```{r, message=FALSE, warning=FALSE}
proportionsDriveFrequncy <- 
  proportionPivot(ctd, 'driveFrequency') %>%
  proportionPlot('driveFrequency', 'Drive Frequency') %>%
  print()
```
#####Geography
- Geography does not appear to split behavior well
```{r, message=FALSE, warning=FALSE}
proportionsGeography <- 
  proportionPivot(ctd, 'geography') %>%
  proportionPlot('geography', 'Geography') %>%
  print()
```

###Trees
- Decision trees can be valuable to work through behavioral differences in an outcome by many categorical valuues
- In each box, we have the level of the outcome we are interested in, average value of that outcome, and the proportion of the population in that node
- Below the box is the most important splitter at that node, where most important is determined by the seperation that creates the largest wedge in the average value of the output
- For instance, for the Control tree, we see that the average value is 41% of people texting and driving. The most powerful split is whether the person has a license
- If they have a licence, we proceed down the "NO" branch. If they do not, we see that there are no more important splits, and the average value is 4% texting and driving, encompassing 32% of the population
- The "NO" branch proceeds down splitting on driving frequency and then terminates
- The tree suggests the most important splits for us to look into, by group, while also providing a useful summary of outcomes
- The fact that the experiment tree has more nodes suggests that the experiment's impact do tend to vary by the factors available, while behavior does not vary a lot without the campaign
- It also suggest that geography may yet be an interesting splitter
```{r, message=FALSE, warning=FALSE}
control <- rpart(
  as.factor(textDrive.yn) ~ 
    gender + geography + driveFrequency + licenseType, 
  data = ctd[group=='Control' & !is.na(textDrive.yn)]
  , cp=0.01)

exp <- rpart(
  as.factor(textDrive.yn) ~ 
    group + gender + geography + driveFrequency + licenseType, 
  data = ctd[group!='Control']
  , cp=0.01) 

rpart.plot(control, main="Control")
rpart.plot(exp, main='Experiment')
```
- To get a more robust answer for the most predictive factors, we utilize a Random Forest algorithm
- Random Forest:
    - Random forest is a common ML technique wherein many decision trees are grown with random bundles of candidate features
    - The supplied dataset is also repeatedly sub-sampled to provide different views to trees
    - Each tree then provides a "vote" towards the final model, where the vote is weighted by the tree's ability to succesfully predict outcomes on the out of sample set
    - It has several advantages, including its ability to utilize non-linear relationships between predictors and outcomes
    - It also makes no distributional assumptions on the outcome
    - It also provides comprehensible variable importance metrics as seen below
```{r, message=FALSE, warning=FALSE}
ctrl = trainControl(method="repeatedcv", number=10, repeats=2, selectionFunction = "oneSE", 
                    classProb=T, summaryFunction = twoClassSummary, savePredictions = TRUE)

ctd %<>% mutate(textDrive.rf = as.factor(ifelse(textDrive.yn == 1, 'yes', 'no')))

candidates = c('gender', 'geography', 'driveFrequency', 'licenseType', 'group')
formula = as.formula(paste('textDrive.rf ~ ',paste(candidates, sep = ' + ', collapse = '+')))

rf = train(
  formula, 
  data=ctd[!is.na(textDrive.yn)], 
  method="rf", 
  metric="ROC",
  trControl=ctrl
)

varImp(rf, scale=FALSE) %>% plot(main = 'Variable Importance')
```

###Estimate Effects
- We feed in the identified candidate features into a logistic regression model to understand the effect size of each factor as well as the experiment itself
- Geographic features fail to make the final cut
- We determine that the impact of the experiment varies most by license types, frequency of driving, and having participated in the campaign
- We confirm that the effectiveness of the campaign is concentrated among licensed drivers and the its effectiveness dampens over time, but remains robust
- This suggests that, in the future, the campaign should focus on licensed drivers as we may be having unintended effects on the permitted population, who already appears to be sufficiently deterred from texting and driving
- The raw table of estimates likelihoods is also provided
```{r, , message=FALSE, warning=FALSE}

remainingCandidates <- c('geography', 'driveFrequency', 'licenseType', 'group')
formula = as.formula(paste('textDrive.yn ~ ',paste(remainingCandidates, sep = ' + ', collapse = '+')))

linMod <- glm(formula, 'binomial', data = ctd[!is.na(textDrive.yn)])

finalCandidates <- c('driveFrequency', 'licenseType', 'group')
formula = as.formula(paste('textDrive.yn ~ ',paste(finalCandidates, sep = ' + ', collapse = '+'), '+ group*licenseType'))

linMod <- glm(formula, 'binomial', data = ctd[!is.na(textDrive.yn)])

effects <- 
  data.table(
  Name = names(coef(summary(linMod))[,1]), 
  Coef = coef(summary(linMod))[,1], 
  SE = coef(summary(linMod))[,2],
  pVal = round(coef(summary(linMod))[,4], 4)
  ) %>%
  tbl_dt() %>%
  filter(Name != '(Intercept)') %>%
  mutate(
    effectSize = logit2prob(Coef)
  )

Probs <- 
  expand.grid(
    driveFrequency = unique(ctd[!is.na(textDrive.yn), driveFrequency]),
    licenseType = unique(ctd[!is.na(textDrive.yn), licenseType]),
    group = unique(ctd[!is.na(textDrive.yn), group])
  ) %>%
  tbl_dt()
Probs %<>% mutate(pTextDrive = predict(linMod, Probs, type='response'))

ggplot(Probs, aes(x=driveFrequency, y=pTextDrive, group=group)) + 
  geom_bar(stat='identity', position='dodge', aes(fill=group)) + 
  facet_wrap(~licenseType) + scale_y_continuous(breaks = pretty_breaks(n=20)) +
  labs(x='Driving Frequency', y='Likelihood to Text & Drive', title='Campaign Effectiveness') + 
  theme(plot.title = element_text(hjust = 0.5))

probTable <- 
  Probs %>%
  spread(
    group, pTextDrive
  ) %>%
  kable(align = 'l', digits = 4) %>%
  print()

```

